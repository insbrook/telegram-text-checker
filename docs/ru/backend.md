# Бэкенд

[&larr; Назад](./README.md)

Доступные языки: **RU** [EN](./../../backend.md)

## Содержание

Чтобы упростить разработчикам возможность использовать весь проект или его части
в других проектах все компоненты максимально совместимы со стандартами PSR.

- [Минимальные требования](#reqs)
- [Настраиваем бэкенд](#setup)
- [Что под капотом](#hood)
- [Логирование](#logging)
- [Доработка и отладка](#debug)

## <a name="reqs"></a>Минимальные требования

- PHP8.1 или свежее with curl, json and mbstring modules.
- Менеджер зависимостей Composer.

Мануалы по установке:
- [How to install PHP](https://www.php.net/manual/en/install.php)
- [Composer for PHP installation](https://getcomposer.org/download/)

## <a name="setup"></a>Настраиваем бэкенд

У вас должно быть установлено все необходимое программное обеспечение из раздела [Минимальные требования](#reqs).
Клонируйте этот репозиторий и установите необходимые зависимости, используя команду `composer install` из корня каталога проекта или `./composer.phar install`
если используете автономную версию Composer.

Все настройки бота берутся из файла `.env`. Чтобы создать его, просто скопируйте файл `.env-sample` в файл `.env`.
Затем откройте файл `.env` и укажите свои значения.

- `TELEGRAM_TOKEN` — это токен API, который можно получить у [BotFather](https://t.me/BotFather) в настройках для вашего бота.
- `POLLING_LIFETIME` - *необязательный* параметр. Максимальное время жизни команды опроса консоли. Используйте его, если вы используете cron запуска команды по расписанию.
- `TEXTGEARS_CHECKER_API_KEY` — *необязательный* параметр. Требуется, если вы планируете использовать TextGears API для анализа текста.

После заполнения файла `.env` запустите проверку, чтобы убедиться, что все в порядке.
Из консоли командой `php public/index.php status` или откройте корень сайт для проверки веб-сервера.

Вы можете в любое время запустить эту команду, чтобы проверить работоспособность бота и предотвратить возможные ошибки во время работы.

##### Возможные ошибки и способы их исправления

| Ошибка                                                                                                                 | Как починить                                                                                                                                                                                                                          |
|------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Telegram bot token not set. Env file not exists                                                                        | Файл `.env` не найден в корневом каталоге проекта.                                                                                                                                                                                    |
| Telegram bot token not set. Env file exists, but user 'www-data' have no reading access to the file                    | Файл `.env` существует, но не может быть прочитан. Проверьте права доступа к файлу и пользователю.                                                                                                                                    |
| Telegram bot token not set. Check your .env file                                                                       | Файл `.env` найден и прочитан. Но токен не найден. Установите токен или проверьте формат файла на наличие ошибок.                                                                                                                     |
| Bot token is set, but invalid                                                                                          | Установите актуальный токен API бота из [BotFather](https://t.me/BotFather).                                                                                                                                                          |
| Cannot save file '...'. Data directory '...' does not exists                                                           | Боту в процессе работы необходимо сохранять некоторые внутренние параметры в файлы, расположенные в каталоге data в корне проекта. Каталог должен существовать и быть доступным для записи боту и веб-серверу (если используете его). |
| Cannot save file '...'. Data directory '...' exists but not writable for user 'www-data'                               | Каталог данных должен быть доступен для записи боту. Измените владельца каталога и его содержимого или установите более широкие разрешения, чтобы разрешить запись.                                                                   |
| Cannot save file '...'. File exists but not writable for user 'www-data'                                               | Доступ к файлу с данными, необходимыми для работы, запрещен. Измените владельца файла или установите более широкие права, чтобы разрешить запись.                                                                                     |
| Cannot save file '...'. No free space on disk                                                                          | Похоже, на диске закончилось место. Для корректной работы боту требуется некоторое свободное место на диске. Удалите какие-нибудь менее полезные файлы, чем файлы бота.                                                               |
| Cannot save file '...'. Directory exists, directory permissions are OK, free disk space is OK. Unknown failure reason. | Проверьте количество свободных inode, лимит на количество открытых файлов и состояние диска.                                                                                                                                          |

##### Что такое успех?

У меня есть ответ на этот вопрос. Успех выглядит так:

```
{
    "Time": "2023-10-07T13:19:11+00:00",
    "Token": "OK",
    "Username": "TextGearsBot",
    "WebHook": "Not set",
    "Last processed update id": 403194207,
    "Everything is OK": "Yes, sir!"
}
```

Базовый функционал бэкенда готов.

Запустите `php public/index.php poll`, чтобы начать поллинг Telegram на предмет входящих событий бота и обработать его!

## <a name="hood"></a> Что под капотом

### Каркас

Что есть современное бэкенд-приложение? Сервис-контейнер, обеспечивающий гибкое внедрение зависимостей + диспетчер обработки запросов.

Все общие классы расположены в `src/Framework`.

`TelegramApp\Framework\Container` &ndash; PSR-совместимый сервис-контейнер. 
Он конфигурируется очень простым и наглядным образом из файла `src\services.php`. Посмотрите, все станет понятнее.

Для обработки каждого запроса `TelegramApp\Framework\App` выбирает контроллер из сервис-контейнера 
согласно правилам маршрутизации. Дальше `App` инстанцируем объект запроса `RequestInterface` и обращается к контроллеру обработать его для получения
ответа. Весь код довольно прост, но PSR-совместим.

### Приложение

Фактически бэкенд выполняет две задачи: проверка текста и взаимодействие с Telegram.

#### Взаимодействие с Telegram

Запустите `php public/index.php poll`, чтобы начать поллинг Telegram для получения и обработки событий бота.

Вы можете настроить системный демон или контейнер для перезапуска команды после завершения или запускать ее по расписанию через `crontab -e`, например, каждые 10 минут.
Чтобы ограничить время жизни команды поллинга интервалом в 10 минут, можно установить время жизни в секундах в файле `.env` `POLLING_LIFETIME=600`

Обработка событий-апдейтов Telegram происходит в контроллере `TelegramApp\App\Controllers\Poll`.
Вы можете поменять логику обработки в соответствуюзих хендлерах или добавить свой обработчик для нового типа.

```php
$handlerMap = [
    'inline_query' => Handlers\InlineQueryHandler::class,
    'message' => Handlers\MessageHandler::class,
    'callback_query' => Handlers\CallbackQueryHandler::class,
];
foreach ($handlerMap as $type => $handlerClass) {
    if (empty($update[$type])) {
        continue;
    }
    $handler = $this->container->get($handlerClass);
    $handler->handle($this->telegramClient, $lastId, $update);
}
```

## <a name="logging"></a>Логирование

Бэкенд приложения работает с PSR-совместимыми механиками логирования.
This app provides a PSR-compatible logging mechanics. Чтобы использовать логирование в каком-то классе
вам надо всего лишь установить интерфейс `implements LoggerAwareInterface` и трейт `use LoggerAwareTrait;` от PSR.
При инстанцировании класса с этим интерфейсом `Container` автоматически установит классу логер.
И логирование будет уже к вашим услугам:

```php
if ($this->logger) {
    $this->logger->debug("Telegram API call: {$apiMethod}", [
        'data' => $data,
    ]);
}
```

Куда логер сохраняет информацию? Давайте посмотрим на конфиг сервис-контейнера  `src/services.php`.
```php
LoggerInterface::class => Framework\FileLogger::class,
```

или его версию для тестового окружения `test/services.php`:

```php
// Log to an array for debug purposes
LoggerInterface::class => MocksAndFakers\ArrayLogger::class,
```

Я реализровал простой пример логирования в файл и пример логирования в массив для тестовых нужд.
Вы можете без проблем сделать свой логер или использовать стороннюю библиотеку.
И единственное, что вам надо будет сделать чтобы поменять логер &ndash; это поменять строчку в конфиге!
Слава PSR!
```php
// Например
LoggerInterface::class => YourMySqlLogger::class,
```

## <a name="debug"></a>Доработка и отладка

Серверная часть приложения идет с юнит-тестами, удобными для проверки и отладки.
Готовый моки и фейкеры тоже к вашим услугам!

**Если вы никогда не использовали юнит-тесты, сегодня &ndash; лучший день чтобы начать.**

Как запустить юнит-тесты?

`./vendor/bin/phpunit`

Как запустить конкретный юнит-тест?

`./vendor/bin/phpunit ./test/App/Controller/StatusTest.php`
